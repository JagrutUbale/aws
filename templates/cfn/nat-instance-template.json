{
  "AWSTemplateFormatVersion" : "2010-09-09",
  "Description" : "Deploy a NAT instance with enhanced network capabilities.",

  "Parameters" : {

    "aAvailZone" : {
        "Type"                          : "String",
        "Default"                       : "us-east-1b",
        "AllowedPattern"                : "us-east-1[a-e]|us-west-[1-2a-c]|eu-west-1[a-c]|ap-northeast-1[a-c]|ap-southeast-[1-2a-c]|sa-east-1[a-c]|eu-central-1[a-c]",
        "Description"                   : "Name of the availability-zone."
    },
    "bPubSubnetId" : {
        "Type"                          : "AWS::EC2::Subnet::Id",
        "Description"                   : "Public subnet Id for AvailZone."
    },
    "cInstanceType" : {
        "Type"                          : "String",
        "Default"                       : "c3.2xlarge",
        "Description"                   : "NAT instance size. Note: for enhanced networking, choose a c3, r3 or i2 class instance."
    },
    "dUserKeys" : {
        "Type"                          : "AWS::EC2::KeyPair::KeyName",
        "Description"                   : "Name of your key pair."
    },
    "eNATSecurityGroup" : {
        "Type"                          : "AWS::EC2::SecurityGroup::Id",
        "Description"                   : "NAT security group Id."
    },
    "fNATName" : {
        "Type"                          : "String",
        "Default"                       : "nat-gw-az1",
        "AllowedPattern"                : "[-a-z0-9]*",
        "Description"                   : "Instance name (for tagging)."
    },
    "gOwnerService" : {
        "Type"                          : "String",
        "Default"                       : "eng",
        "AllowedPattern"                : "[-a-z0-9]*",
        "Description"                   : "Service name (for tagging)."
    },
    "hStackEnv" : {
        "Type"                          : "String",
        "Default"                       : "stage",
        "AllowedPattern"                : "[-a-z0-9]*",
        "Description"                   : "Environment name (for tagging)."
    }
  },

  "Mappings" : {

    "RegionNATAMI" : {
        "us-east-1"                     : { "AMI" : "ami-4c9e4b24" },
        "eu-west-1"                     : { "AMI" : "ami-3760b040" },
        "ap-northeast-1"                : { "AMI" : "ami-55c29e54" },
        "us-west-1"                     : { "AMI" : "ami-2b2b296e" },
        "us-west-2"                     : { "AMI" : "ami-bb69128b" },
        "ap-southeast-1"                : { "AMI" : "ami-b082dae2" },
        "ap-southeast-2"                : { "AMI" : "ami-996402a3" },
        "sa-east-1"                     : { "AMI" : "ami-b972dba4" },
        "eu-central-1"                  : { "AMI" : "ami-204c7a3d" }
    }
  },

  "Resources" : {

    "ec2IPAddressNAT" : {
      "Type" : "AWS::EC2::EIP",
      "Properties" : {
        "Domain"                        : "vpc",
        "InstanceId"                    : { "Ref" : "ec2NATInstance" }
      }
    },

    "iamNATRole" : {
      "Type" : "AWS::IAM::Role",
      "Properties" : {
        "AssumeRolePolicyDocument": {
          "Statement" : [ {
            "Effect" : "Allow",
            "Principal" : {
              "Service" : [ "ec2.amazonaws.com" ]
            },
            "Action" : [ "sts:AssumeRole" ]
          } ]
        },
        "Path" : "/",
        "Policies" : [ {
          "PolicyName" : "NATMonitor",
          "PolicyDocument" : {
            "Statement" : [ {
              "Effect" : "Allow",
              "Action" : [
                        "ec2:CreateRoute",
                        "ec2:DescribeInstances",
                        "ec2:ReplaceRoute",
                        "ec2:StartInstances",
                        "ec2:StopInstances"
              ],
              "Resource" : "*"
            } ]
          }
        } ]
      }
    },

    "iamNATMonitorProfile" : {
      "Type": "AWS::IAM::InstanceProfile",
      "Properties" : {
        "Path" : "/",
        "Roles" : [ { "Ref": "iamNATRole" } ]
      }
    },

    "ec2NATInstance" : {
      "Type" : "AWS::EC2::Instance",
      "Properties" : {
        "AvailabilityZone"              : { "Ref" : "aAvailZone" },
        "ImageId"                       : { "Fn::FindInMap" : [ "RegionNATAMI", { "Ref" : "AWS::Region" }, "AMI" ] },
        "InstanceType"                  : { "Ref" : "cInstanceType" },
        "Tenancy"                       : "default",
        "Monitoring"                    : "true",
        "SourceDestCheck"               : "false",
        "DisableApiTermination"         : "true",
        "KeyName"                       : { "Ref" : "dUserKeys" },
        "SecurityGroupIds"              : [ { "Ref" : "eNATSecurityGroup" } ],
        "SubnetId"                      : { "Ref" : "bPubSubnetId" },
        "IamInstanceProfile"            : { "Ref": "iamNATMonitorProfile" },
        "Tags": [
            { "Key" : "Stack", "Value" : { "Ref" : "AWS::StackName"} },
            { "Key" : "Owner", "Value" : { "Ref" : "gOwnerService" } },
            { "Key" : "Env",   "Value" : { "Ref" : "hStackEnv" } },
            { "Key" : "Name",  "Value" : { "Ref" : "fNATName" } }
        ]
      },
      "DependsOn" : [ "iamNATMonitorProfile" ]
    }
  },

  "Outputs" : {

    "NatId" : {
    "Description"                       : "NAT Id",
    "Value"                             : { "Ref" : "ec2NATInstance" }
    },
    "NatIP" : {
    "Description"                       : "NAT Public IP",
    "Value"                             : { "Fn::GetAtt" : [ "ec2NATInstance", "PublicIp" ] }
    }
  }
}
